# 결제 시스템 설계

## 📋 개요

PromptHub 플랫폼의 프롬프트 판매 및 결제 시스템 설계 문서입니다.

### 기본 방향성
- **도입 시기**: MVP 완성 후, 사용자 기반 확보 시점
- **플랫폼 수수료**: 20% (실제 수익 약 16.81%)
- **선택 PG사**: 토스페이먼츠

## 💳 PG사 비교 결과

### 주요 후보 서비스 비교

| 서비스 | 구분 | 카드 수수료 | 가입비 | 구현 난이도 | 장점 | 단점 |
|--------|------|-------------|--------|-------------|------|------|
| **토스페이먼츠** ⭐ | PG사 직연동 | 2.9% + VAT | 약 22만원 | ⭐⭐⭐ | 개발자 친화적 API<br>우수한 문서<br>안정적 시스템 | 단일 PG 의존 |
| **포트원(아임포트)** | PG 통합 플랫폼 | PG사별 + 추가비용 | 가입비 면제 혜택 | ⭐⭐⭐⭐ | 여러 PG 한 번에 연동<br>PG 변경 용이<br>리스크 분산 | 복잡한 구조<br>의존성 추가 |
| **쿠키페이먼츠** | PG 통합 플랫폼 | 영중소 1.5~2.6%<br>일반 2.9% | - | ⭐⭐⭐ | 저렴한 수수료<br>빠른 정산 (D+3) | 상대적으로 작은 규모<br>제한적 정보 |

### 선택 근거: 토스페이먼츠
1. **개발 속도**: MVP 단계에서 빠른 구현 가능
2. **안정성**: 검증된 시스템과 인프라
3. **문서화**: 개발자 친화적인 API 문서
4. **확장성**: 추후 포트원 등으로 전환 가능

## 💰 수수료 구조

### 수익 분배 (1만원 프롬프트 판매 기준)
```
고객 결제금액: 10,000원
├─ PG 수수료 (토스페이먼츠): 319원 (2.9% + VAT)
├─ 플랫폼 수수료 (PromptHub): 1,681원 (16.81%)
└─ 판매자 수취액: 7,681원 (76.81%)
```

### 수수료 계산 공식
- **PG 수수료**: 결제금액 × 2.9% × 1.1(VAT) = 3.19%
- **플랫폼 실수익**: 20% - 3.19% = 16.81%

## 🗃️ 데이터베이스 설계 변경사항

### p_prompt 테이블 필드 추가
```sql
-- 판매 관련 필드 추가
price          integer      not null default 0,     -- 가격 (0 = 무료, 단위: 원)
is_premium     boolean      not null default false, -- 프리미엄(유료) 프롬프트 여부
sales_count    integer      not null default 0,     -- 판매 횟수
```

### p_prompt_purchase 테이블 (신규) - 필수 - 도입 완료
```sql
-- 프롬프트 구매/판매 기록 테이블
CREATE TABLE p_prompt_purchase (
                                   id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                   prompt_id BIGINT NOT NULL REFERENCES p_prompt(id),
                                   buyer_id BIGINT NOT NULL REFERENCES p_member(id),
                                   seller_id BIGINT NOT NULL REFERENCES p_member(id),
                                   purchase_price INTEGER NOT NULL,
                                   purchased_at TIMESTAMP(6) NOT NULL,
                                   updated_at TIMESTAMP(6),
                                   payment_method VARCHAR(20) NOT NULL
                                       CONSTRAINT p_prompt_purchase_payment_method_check
                                           CHECK ((payment_method)::text = ANY
                                       ((ARRAY ['CARD'::character varying, 'BANK_TRANSFER'::character varying,
                                       'VIRTUAL_ACCOUNT'::character varying, 'TOSS_PAY'::character varying,
                                       'KAKAO_PAY'::character varying, 'NAVER_PAY'::character varying])::text[])),
    payment_key VARCHAR(200),
    payment_status VARCHAR(20) NOT NULL DEFAULT 'COMPLETED'
        CONSTRAINT p_prompt_purchase_payment_status_check
            CHECK ((payment_status)::text = ANY
                   ((ARRAY ['PENDING'::character varying, 'COMPLETED'::character varying,
                           'CANCELLED'::character varying, 'FAILED'::character varying,
                           'REFUNDED'::character varying])::text[])),
    CONSTRAINT uk_buyer_prompt_purchase UNIQUE (buyer_id, prompt_id)
);

ALTER TABLE p_prompt_purchase
    OWNER TO spring;
```

### p_settlement 테이블 (유료 서비스 도입 시) - 중요
```sql
-- 판매자별 정산 기록 테이블
create table p_settlement (
    id             bigint generated by default as identity primary key,
    seller_id      bigint not null references p_member(id),
    period_start   date not null,              -- 정산 기간 시작
    period_end     date not null,              -- 정산 기간 종료
    total_sales    integer not null,           -- 총 판매액
    commission     integer not null,           -- 플랫폼 수수료
    settlement_amount integer not null,        -- 실제 정산액
    status         varchar(20) default 'PENDING', -- PENDING, COMPLETED, FAILED
    settled_at     timestamp(6),
    created_at     timestamp(6)
);
```

**필요한 이유:**
- 월/주간 정산 관리: "이번 달 정산액은 얼마?"
- 정산 이력 추적: "언제 얼마 정산받았나?"
- 세무 관리: 판매자 소득 신고 자료 제공

### p_notification 테이블 (유료 서비스 도입 시) - 중요
```sql
-- 알림 테이블
create table p_notification (
    id         bigint generated by default as identity primary key,
    member_id  bigint not null references p_member(id),
    type       varchar(50) not null,          -- PURCHASE, SALE, SETTLEMENT, REFUND
    title      varchar(200) not null,         -- 알림 제목
    content    text,                          -- 알림 내용
    is_read    boolean default false,         -- 읽음 여부
    created_at timestamp(6)
);
```

**필요한 이유:**
- 구매 알림: "프롬프트 구매가 완료되었습니다"
- 판매 알림: "회원님의 프롬프트가 판매되었습니다"
- 정산 알림: "정산이 완료되었습니다"

### p_refund 테이블 (환불 정책 도입 시) - 선택적
```sql
-- 환불 기록 테이블
create table p_refund (
    id             bigint generated by default as identity primary key,
    purchase_id    bigint not null references p_prompt_purchase(id),
    refund_reason  varchar(500),              -- 환불 사유
    refund_amount  integer not null,          -- 환불 금액
    refund_method  varchar(50),               -- 환불 방법 (원결제수단 등)
    status         varchar(20) default 'REQUESTED', -- REQUESTED, APPROVED, COMPLETED, REJECTED
    requested_at   timestamp(6),
    processed_at   timestamp(6)
);
```

**필요한 이유:**
- 환불 프로세스 관리: 요청 → 승인 → 처리 단계별 추적
- 분쟁 해결: 환불 사유와 처리 내역 보관
- 통계 분석: 환불률, 환불 사유 분석

## 🔄 환불 정책 (향후 검토사항)

### 현재 방침
- **MVP 단계**: 무료 프롬프트만 제공하므로 환불 이슈 없음
- **유료 도입 시**: 아래 정책 검토 예정

### 제안하는 환불 정책 (참고용)
```
✅ 환불 가능한 경우:
- 프롬프트가 설명과 완전히 다를 때
- 기술적 오류로 다운로드 불가할 때

❌ 환불 불가능한 경우:
- 단순 변심 (구매 후 내용 확인했으면)
- 개인 취향에 맞지 않을 때
- 본인 실력 부족으로 활용 못할 때

⏰ 환불 기간: 구매 후 24시간 이내
💳 환불 방식: 원결제수단으로 자동 환불
```

### 환불 정책의 장점
- **고객 신뢰도 향상**: "환불 정책 존재" 자체로 신뢰감 증대
- **품질 관리**: 판매자들이 품질에 더 신경 씀
- **예상 환불률**: 5% 이하 (대부분은 귀찮아서 환불 안 함)

## 🚀 구현 로드맵

### Phase 1: 데이터베이스 준비 (현재)
- [x] 가격 관련 필드 추가 설계
- [ ] 스키마 파일 업데이트
- [ ] 엔티티 클래스 수정

### Phase 2: 결제 시스템 도입 (사용자 기반 확보 후)
1. **토스페이먼츠 가입**
   - 사업자등록 필요 (개인사업자 가능)
   - 가입비: 약 22만원
   - 심사 기간: 영업일 기준 7일

2. **API 연동 개발**
   - 결제 요청/응답 처리
   - 결제 검증 로직
   - 웹훅 처리

3. **UI/UX 개발**
   - 결제 페이지
   - 구매 내역 페이지
   - 판매자 정산 페이지

### Phase 3: 확장 고려사항
- **포트원 도입**: 여러 PG 옵션 확보
- **해외 결제**: PayPal 등 해외 결제 수단
- **정기 결제**: 구독 모델 도입 시

## 🔍 추가 고려사항

### 멘토 피드백 반영
- **수익 모델**: PromptBase 참고 (20% 수수료)
- **시장 확장**: 영어 서비스 고려
- **품질 관리**: 커뮤니티 기반 개선 (깃허브 스타일)

### 기술적 고려사항
- **결제 보안**: PCI-DSS 준수
- **트래픽 대응**: 결제 몰림 현상 대비
- **로깅**: 결제 관련 상세 로그 기록
- **모니터링**: 결제 성공률, 실패율 추적

## 📚 참고 자료

- [토스페이먼츠 개발자 문서](https://docs.tosspayments.com/)
- [전자금융거래법 가이드라인](https://www.fss.or.kr/)
- [개인정보보호법 (결제정보)](https://privacy.go.kr/)

---
*최종 수정일: 2025-09-12*
*작성자: PromptHub 개발팀*
