# 프롬프트허브(PromptHub) 데이터베이스 설계

## 📊 ERD 개요
```
users (사용자) 
  ↓ 1:N
prompts (프롬프트)
  ↓ N:1
categories (카테고리)

users ←→ prompts (N:M) via prompt_likes (좋아요)
users ←→ prompts (N:M) via prompt_bookmarks (북마크)
prompts ←→ tags (N:M) via prompt_tags (태그)
```

## 🗃️ 테이블 상세 설계

### 1. 카테고리
```
create table p_category
(
    id          bigint generated by default as identity
        primary key,
    createdat   timestamp(6),
    description text,
    isactive    boolean     not null,
    name        varchar(50) not null
        constraint uknu7gee55si4emj6suq55er2wv
            unique,
    updatedat   timestamp(6)
);

alter table p_category
    owner to spring;
```

### 2. 회원
```
CREATE TABLE p_member (
    email_verified BOOLEAN NOT NULL,
    deactivated_at TIMESTAMP(6),
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    registered_at TIMESTAMP(6),
    updated_at TIMESTAMP(6),
    provider VARCHAR(20)
        CONSTRAINT p_member_provider_check
            CHECK ((provider)::text = ANY
                   ((ARRAY ['GOOGLE'::character varying, 'NAVER'::character varying, 'KAKAO'::character varying])::text[])),
    role VARCHAR(50) NOT NULL
        CONSTRAINT p_member_role_check
            CHECK ((role)::text = ANY ((ARRAY ['USER'::character varying, 'ADMIN'::character varying])::text[])),
    status VARCHAR(50) NOT NULL
        CONSTRAINT p_member_status_check
            CHECK ((status)::text = ANY
                   ((ARRAY ['ACTIVE'::character varying, 'DEACTIVATED'::character varying])::text[])),
    nickname VARCHAR(100) NOT NULL,
    provider_id VARCHAR(100),
    email_address VARCHAR(150) NOT NULL,
    password_hash VARCHAR(200),
    profile_image_url VARCHAR(500),  -- 프로필 이미지 URL
    introduction TEXT,                        -- 자기소개
    CONSTRAINT uk_email_provider UNIQUE (email_address, provider)
);

alter table p_member
    owner to spring;
```

### 3. 프롬프트
```
create table p_prompt
(
    id             bigint generated by default as identity
        primary key,
    content        text         not null,
    createdat      timestamp(6),
    description    text,
    ispublic       boolean      not null,
    likescount     integer      not null default 0,
    title          varchar(200) not null,
    updatedat      timestamp(6),
    viewscount     integer      not null default 0,
    average_rating decimal(3,2) default 0.0,
    reviews_count  integer      default 0,
    -- 판매 관련 필드 추가
    price          integer      not null default 0,  -- 가격 (0 = 무료, 단위: 원)
    is_premium     boolean      not null default false
    sales_count    integer      not null default 0,  -- 판매 횟수
    category_id    bigint
        constraint fka16juxw5kxakt90ws8ogb4w7l
            references p_category,
    member_id      bigint
        constraint fkv8rkui4wse6rh8t01qw3po42
            references p_member(id)
);

alter table p_prompt
    owner to spring;
```

### 4. 프롬프트 - 좋아요
```
create table p_prompt_like
(
    id        bigint generated by default as identity
        primary key,
    createdat timestamp(6),
    member_id bigint
        constraint fk1uco9nk6vnd75otk7nwsb6flq
            references p_member(id),
    prompt_id bigint
        constraint fkptt5htv66nclb079dxlaohv1l
            references p_prompt(id),
    constraint uk3w6tqtrb6nu5bfocj0pwrpl9b
        unique (member_id, prompt_id)
);

alter table p_prompt_like
    owner to spring;
```

### 5. 태그
```
-- 태그 테이블
create table p_tag
(
    id        bigint generated by default as identity primary key,
    name      varchar(50) not null unique,
    createdat timestamp(6),
    isactive  boolean not null default true
);
```

### 6. 프롬프트 - 태그 연결 테이블
```
-- 프롬프트-태그 연결 테이블 (Many-to-Many)
create table p_prompt_tag
(
    id        bigint generated by default as identity primary key,
    prompt_id bigint not null references p_prompt(id),
    tag_id    bigint not null references p_tag(id),
    createdat timestamp(6),
    constraint uk_prompt_tag unique (prompt_id, tag_id)
);
```

### 7. 리뷰/평점 테이블
```
-- 리뷰 테이블 (평점 + 텍스트 리뷰 통합)
create table p_review
(
    id        bigint generated by default as identity primary key,
    prompt_id bigint not null references p_prompt(id),
    member_id bigint not null references p_member(id),
    rating    integer not null check (rating >= 1 and rating <= 5),
    content   varchar(500),
    createdat timestamp(6),
    updatedat timestamp(6),
    constraint uk_member_prompt_review unique (member_id, prompt_id)
);
```

### 8. 프롬프트 구매 기록
```
-- 프롬프트 구매/판매 기록 테이블
CREATE TABLE p_prompt_purchase (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    prompt_id BIGINT NOT NULL REFERENCES p_prompt(id),
    buyer_id BIGINT NOT NULL REFERENCES p_member(id),
    seller_id BIGINT NOT NULL REFERENCES p_member(id),
    purchase_price INTEGER NOT NULL,
    purchased_at TIMESTAMP(6) NOT NULL,
    updated_at TIMESTAMP(6),
    payment_method VARCHAR(20) NOT NULL
        CONSTRAINT p_prompt_purchase_payment_method_check
            CHECK ((payment_method)::text = ANY
                   ((ARRAY ['CARD'::character varying, 'BANK_TRANSFER'::character varying, 
                           'VIRTUAL_ACCOUNT'::character varying, 'TOSS_PAY'::character varying,
                           'KAKAO_PAY'::character varying, 'NAVER_PAY'::character varying])::text[])),
    payment_key VARCHAR(200),
    payment_status VARCHAR(20) NOT NULL DEFAULT 'COMPLETED'
        CONSTRAINT p_prompt_purchase_payment_status_check
            CHECK ((payment_status)::text = ANY
                   ((ARRAY ['PENDING'::character varying, 'COMPLETED'::character varying,
                           'CANCELLED'::character varying, 'FAILED'::character varying,
                           'REFUNDED'::character varying])::text[])),
    CONSTRAINT uk_buyer_prompt_purchase UNIQUE (buyer_id, prompt_id)
);

ALTER TABLE p_prompt_purchase
    OWNER TO spring;
```

### 9. 문의 테이블 - TBD
```
CREATE TABLE p_inquiry (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    member_id BIGINT REFERENCES p_member(id),
    category VARCHAR(50) NOT NULL, -- '기술지원', '계정문의', '기타'
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    contact_email VARCHAR(150), -- 비회원도 문의 가능
    contact_name VARCHAR(100),   -- 비회원 이름
    status VARCHAR(20) DEFAULT 'PENDING', -- 'PENDING', 'IN_PROGRESS', 'RESOLVED'
    admin_reply TEXT,
    created_at TIMESTAMP(6),
    updated_at TIMESTAMP(6),
    resolved_at TIMESTAMP(6)
);
```