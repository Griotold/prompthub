# 프롬프트허브(PromptHub) 데이터베이스 설계

## 📊 ERD 개요
```
users (사용자) 
  ↓ 1:N
prompts (프롬프트)
  ↓ N:1
categories (카테고리)

users ←→ prompts (N:M) via prompt_likes (좋아요)
users ←→ prompts (N:M) via prompt_bookmarks (북마크)
prompts ←→ tags (N:M) via prompt_tags (태그)
```

## 🗃️ 테이블 상세 설계

### 1. users (사용자 테이블)
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE NOT NULL,
    nickname VARCHAR(100) NOT NULL,
    password_hash VARCHAR(200) NOT NULL,
    role VARCHAR(50) NOT NULL,
    status VARCHAR(50) NOT NULL,
    email_verified BOOLEAN NOT NULL DEFAULT false,
    registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deactivated_at TIMESTAMP
);
```

**인덱스:**
- `idx_users_email` on (email)
- `idx_users_nickname` on (nickname)
- `idx_users_status` on (status)

**구현된 도메인 모델:**
- `Member.java` - 회원 집합근 (Aggregate Root)
- `Email.java` - 이메일 값 객체 (Value Object)  
- `Role.java` - USER, ADMIN
- `MemberStatus.java` - ACTIVE, DEACTIVATED

### 2. categories (카테고리 테이블)
```sql
CREATE TABLE categories (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    color VARCHAR(7), -- HEX 색상코드
    icon VARCHAR(50), -- 아이콘 이름
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**초기 데이터:**
- ChatGPT, Claude, Midjourney, Stable Diffusion, 업무 자동화, 콘텐츠 생성, 교육, 기타

### 3. prompts (프롬프트 테이블)
```sql
CREATE TABLE prompts (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    description TEXT,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    category_id BIGINT REFERENCES categories(id) ON DELETE SET NULL,
    
    -- 통계 정보
    likes_count INTEGER DEFAULT 0,
    bookmarks_count INTEGER DEFAULT 0,
    views_count INTEGER DEFAULT 0,
    
    -- 프롬프트 메타데이터
    input_example TEXT,
    output_example TEXT,
    use_case TEXT,
    limitations TEXT,
    
    -- 상태 관리
    is_public BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    status VARCHAR(20) DEFAULT 'ACTIVE', -- ACTIVE, INACTIVE, DELETED
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**인덱스:**
- `idx_prompts_user_id` on (user_id)
- `idx_prompts_category_id` on (category_id)
- `idx_prompts_created_at` on (created_at DESC)
- `idx_prompts_likes_count` on (likes_count DESC)
- `idx_prompts_status` on (status)

### 4. tags (태그 테이블)
```sql
CREATE TABLE tags (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    usage_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**인덱스:**
- `idx_tags_name` on (name)
- `idx_tags_usage_count` on (usage_count DESC)

### 5. prompt_tags (프롬프트-태그 매핑 테이블)
```sql
CREATE TABLE prompt_tags (
    prompt_id BIGINT REFERENCES prompts(id) ON DELETE CASCADE,
    tag_id BIGINT REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (prompt_id, tag_id)
);
```

### 6. prompt_likes (프롬프트 좋아요 테이블)
```sql
CREATE TABLE prompt_likes (
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    prompt_id BIGINT REFERENCES prompts(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, prompt_id)
);
```

**인덱스:**
- `idx_prompt_likes_prompt_id` on (prompt_id)

### 7. prompt_bookmarks (프롬프트 북마크 테이블)
```sql
CREATE TABLE prompt_bookmarks (
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    prompt_id BIGINT REFERENCES prompts(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, prompt_id)
);
```

**인덱스:**
- `idx_prompt_bookmarks_user_id` on (user_id)
- `idx_prompt_bookmarks_prompt_id` on (prompt_id)

## 🔄 트리거 설계

### 좋아요 카운트 업데이트 트리거
```sql
-- 좋아요 추가/삭제시 prompts.likes_count 자동 업데이트
CREATE OR REPLACE FUNCTION update_prompt_likes_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE prompts SET likes_count = likes_count + 1 WHERE id = NEW.prompt_id;
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE prompts SET likes_count = likes_count - 1 WHERE id = OLD.prompt_id;
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_prompt_likes_count
    AFTER INSERT OR DELETE ON prompt_likes
    FOR EACH ROW
    EXECUTE FUNCTION update_prompt_likes_count();
```

### 태그 사용량 업데이트 트리거
```sql
-- 태그 추가/삭제시 tags.usage_count 자동 업데이트
CREATE OR REPLACE FUNCTION update_tag_usage_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE tags SET usage_count = usage_count + 1 WHERE id = NEW.tag_id;
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE tags SET usage_count = usage_count - 1 WHERE id = OLD.tag_id;
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_tag_usage_count
    AFTER INSERT OR DELETE ON prompt_tags
    FOR EACH ROW
    EXECUTE FUNCTION update_tag_usage_count();
```

## 📈 성능 최적화

### 인덱스 전략
1. **복합 인덱스**: (status, created_at), (category_id, created_at)
2. **부분 인덱스**: is_public = true인 데이터만
3. **전문 검색**: title, content에 대한 GIN 인덱스

### 파티셔닝 고려사항
- prompts 테이블이 커지면 created_at 기준 월별 파티셔닝
- 로그성 데이터는 별도 테이블로 분리

## 🎯 MVP 구현 현황

### Phase 1 (Current - 구현 중)
1. ✅ **users (Member 도메인 완료)**
   - Member 엔티티 구현 완료
   - Email 값 객체 구현 완료  
   - Role, MemberStatus enum 구현 완료
   - 회원가입/인증/상태관리 메서드 구현 완료
   - 단위 테스트 작성 완료

2. ⏳ **categories (다음 단계)**
3. ⏳ **prompts (다음 단계)**  
4. ⏳ **prompt_likes (다음 단계)**

### Phase 2 (확장)
1. tags + prompt_tags
2. prompt_bookmarks
3. 트리거 및 성능 최적화

### Phase 3 (고도화)
1. prompt_comments
2. prompt_versions
3. user_follows

## 🚀 향후 확장 테이블

### 추후 추가 예정 테이블
```sql
-- 댓글 테이블
CREATE TABLE prompt_comments (
    id BIGSERIAL PRIMARY KEY,
    prompt_id BIGINT REFERENCES prompts(id) ON DELETE CASCADE,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    parent_id BIGINT REFERENCES prompt_comments(id), -- 대댓글
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 프롬프트 히스토리 테이블 (버전 관리)
CREATE TABLE prompt_versions (
    id BIGSERIAL PRIMARY KEY,
    prompt_id BIGINT REFERENCES prompts(id) ON DELETE CASCADE,
    version INTEGER NOT NULL,
    title VARCHAR(200),
    content TEXT,
    change_summary VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 사용자 팔로우 테이블
CREATE TABLE user_follows (
    follower_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    following_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (follower_id, following_id)
);
```
